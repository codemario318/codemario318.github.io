<!doctype html><html lang=ko dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="가상 면접 사례로 배우는 대규모 시스템 설계 기초 2"><title>7. 호텔 예약 시스템</title><link rel=canonical href=https://codemario318.github.io/post/system-design-interview-2/7/><link rel=stylesheet href=/scss/style.min.cbce94e2760d14d60414e59d5a36ab2819232375817e010dbe7be2234b67da1b.css><meta property="og:title" content="7. 호텔 예약 시스템"><meta property="og:description" content="가상 면접 사례로 배우는 대규모 시스템 설계 기초 2"><meta property="og:url" content="https://codemario318.github.io/post/system-design-interview-2/7/"><meta property="og:site_name" content="Mario Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="가상 면접 사례로 배우는 대규모 시스템 설계 기초"><meta property="article:tag" content="System Design Interview"><meta property="article:tag" content="MSA"><meta property="article:tag" content="Micro Service Architecture"><meta property="article:tag" content="RDBMS"><meta property="article:tag" content="Relational Database System"><meta property="article:tag" content="동시성"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="비관적 락"><meta property="article:tag" content="Pessimistic Lock"><meta property="article:tag" content="낙관적 락"><meta property="article:tag" content="Optimistic Lock"><meta property="article:tag" content="캐시"><meta property="article:tag" content="Cache"><meta property="article:tag" content="레디스"><meta property="article:tag" content="Redis"><meta property="article:tag" content="데이터 일관성"><meta property="article:tag" content="Consistency"><meta property="article:tag" content="트랜잭션"><meta property="article:tag" content="Transaction"><meta property="article:tag" content="2단계 커밋"><meta property="article:tag" content="2-Phase Commit"><meta property="article:tag" content="사가"><meta property="article:tag" content="Saga"><meta property="article:tag" content="결과적 일관성"><meta property="article:tag" content="Eventual Consistency"><meta property="article:published_time" content="2024-10-12T14:59:50+09:00"><meta property="article:modified_time" content="2024-10-12T14:59:50+09:00"><meta property="og:image" content="https://codemario318.github.io/post/system-design-interview-2/7/cover.png"><meta name=twitter:title content="7. 호텔 예약 시스템"><meta name=twitter:description content="가상 면접 사례로 배우는 대규모 시스템 설계 기초 2"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://codemario318.github.io/post/system-design-interview-2/7/cover.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-K99591YLGK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K99591YLGK",{anonymize_ip:!1})}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3183752545292673" crossorigin=anonymous></script><meta name=naver-site-verification content="2315bde85c86f66092140cc465c340a2170f3187"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu760fd15c5fbb2f30cf0868dc4a5dc41a_14271_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Mario Blog</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://github.com/codemario318 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><ul class="menu sub-menu"><li><a href=/categories/backend/><span>Backend</span>
<span class=content-count>3</span></a></li><li><a href=/categories/boostcamp/><span>부스트캠프</span>
<span class=content-count>11</span></a></li><li><a href=/categories/cleancode/><span>Clean Code</span>
<span class=content-count>10</span></a></li><li><a href=/categories/common/><span>Common</span>
<span class=content-count>76</span></a></li><li><a href=/categories/data/><span>Data</span>
<span class=content-count>3</span></a></li><li><a href=/categories/db/><span>DB</span>
<span class=content-count>1</span></a></li><li><a href=/categories/frontend/><span>Frontend</span>
<span class=content-count>10</span></a></li><li><a href=/categories/golang/><span>GoLang</span>
<span class=content-count>13</span></a></li><li><a href=/categories/headfirstdesignpatterns/><span>헤드 퍼스트 디자인 패턴</span>
<span class=content-count>22</span></a></li><li><a href=/categories/infra/><span>Infra</span>
<span class=content-count>14</span></a></li><li><a href=/categories/nest/><span>Nest</span>
<span class=content-count>1</span></a></li><li><a href=/categories/network/><span>네트워크</span>
<span class=content-count>1</span></a></li><li><a href=/categories/node/><span>Node</span>
<span class=content-count>6</span></a></li><li><a href=/categories/problemsolving/><span>Problem Solving</span>
<span class=content-count>1</span></a></li><li><a href=/categories/project/><span>Project</span>
<span class=content-count>5</span></a></li><li><a href=/categories/realmysql/><span>Real MySQL</span>
<span class=content-count>53</span></a></li></ul><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1단계-문제-이해-및-설계-범위-확정>1단계: 문제 이해 및 설계 범위 확정</a><ol><li><a href=#비기능-요구사항>비기능 요구사항</a></li><li><a href=#개략적-규모-추정>개략적 규모 추정</a></li></ol></li><li><a href=#2단계-개략적-설계안-제시-및-동의-구하기>2단계: 개략적 설계안 제시 및 동의 구하기</a><ol><li><a href=#api-설계>API 설계</a></li><li><a href=#데이터-모델>데이터 모델</a></li><li><a href=#개략적-설계안>개략적 설계안</a></li></ol></li><li><a href=#3단계-상세-설계>3단계: 상세 설계</a><ol><li><a href=#개선된-데이터-모델>개선된 데이터 모델</a></li><li><a href=#동시성-문제>동시성 문제</a><ol><li><a href=#같은-사용자가-같은-예약-요청을-시도하는-경우><strong>같은 사용자가 같은 예약 요청을 시도하는 경우</strong></a></li><li><a href=#여러-사용자가-하나뿐인-객실을-동시에-예약하는-경우><strong>여러 사용자가 하나뿐인 객실을 동시에 예약하는 경우</strong></a></li></ol></li><li><a href=#시스템-규모-확장>시스템 규모 확장</a><ol><li><a href=#데이터베이스-샤딩>데이터베이스 샤딩</a></li><li><a href=#캐시>캐시</a></li></ol></li><li><a href=#서비스-간-데이터-일관성>서비스 간 데이터 일관성</a></li></ol></li><li><a href=#4단계-마무리>4단계: 마무리</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/system-design-interview-2/7/><img src=/post/system-design-interview-2/7/cover_huf565d8fe7a4f9f5a961306624616abfc_449360_800x0_resize_box_3.png srcset="/post/system-design-interview-2/7/cover_huf565d8fe7a4f9f5a961306624616abfc_449360_800x0_resize_box_3.png 800w, /post/system-design-interview-2/7/cover_huf565d8fe7a4f9f5a961306624616abfc_449360_1600x0_resize_box_3.png 1600w" width=800 height=1143 loading=lazy alt="Featured image of post 7. 호텔 예약 시스템"></a></div><div class=article-details><header class=article-category><a href=/categories/common/ style=background-color:#2a9d8f;color:#fff>Common</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/system-design-interview-2/7/>7. 호텔 예약 시스템</a></h2><h3 class=article-subtitle>가상 면접 사례로 배우는 대규모 시스템 설계 기초 2</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2024/10/12</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><p>이번 장에서는 호텔 체인의 예약 시스템을 설계한다.</p><h2 id=1단계-문제-이해-및-설계-범위-확정>1단계: 문제 이해 및 설계 범위 확정</h2><p>호텔 예약 시스템은 복잡하고 그 컴포넌트는 시스템을 사업에 어떻게 이용할지에 따라 달라지므로 범위를 명확히 해야한다.</p><h3 id=비기능-요구사항>비기능 요구사항</h3><ul><li>높은 수준의 동시성 지원<ul><li>성수기, 대규모 이벤트 기간에는 일부 인기 호텔의 특정 객실을 예약하려는 고객이 많이 몰릴 수 있다.</li></ul></li><li>적절한 지연 시간<ul><li>사용자가 예약을 할 때는 응답 시간이 빠르면 이상적이겠으나 <strong>예약 요청 처리</strong>에 <strong>몇 초 정도</strong> 걸리는 것은 괜찮다.</li></ul></li></ul><h3 id=개략적-규모-추정>개략적 규모 추정</h3><ul><li>총 5,000개 호텔, 100만 개의 객실이 있다고 가정</li><li>평균 <strong>객실의 70%가 사용 중</strong>, 평균 <strong>투숙 기간은 3일</strong>이라고 가정</li><li><code>일일 예상 예약 건수 = (1백만 * 0.7) / 3 ~= 240,000</code></li><li><code>초당 예약 건수 = 240,000 / 하루에 10^5초 ~= 3</code><ul><li>초당 예약 트랜잭션 수(TPS)는 높지 않다.</li></ul></li></ul><p>시스템 내 모든 페이지의 QPS를 계산해본다.</p><p>호텔 예약 시스템은 일반적으로 고객이 아래와 같은 흐름을 거친다.</p><ol><li>호텔/객실 상세 페이지<ul><li>사용자가 호텔/객실 정보를 확인한다.(조회)</li></ul></li><li>예약 상세 정보 페이지<ul><li>날짜, 투숙 인원, 결제 방법 등의 상세 정보를 예약 전에 확인한다.(조회)</li></ul></li><li>객실 예약 페이지<ul><li>사용자가 &lsquo;예약&rsquo; 버튼을 눌러 객실을 예약한다.(트랜잭션 발생)</li></ul></li></ol><p><img src=/post/system-design-interview-2/7/img.png width=1290 height=630 srcset="/post/system-design-interview-2/7/img_hudca757551e48c8d1d2e333630b9f6cbe_51951_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_hudca757551e48c8d1d2e333630b9f6cbe_51951_1024x0_resize_box_3.png 1024w" loading=lazy alt="QPS 분포" class=gallery-image data-flex-grow=204 data-flex-basis=491px></p><p>대략 10%의 사용자가 간 단계에서 다음 단계를 진행한다고 가정하면 최종 예약 TPS는 3이므로, 예약 페이지의 QPS는 30, 객실 정보 확인 페이지의 QPS는 300이다.</p><h2 id=2단계-개략적-설계안-제시-및-동의-구하기>2단계: 개략적 설계안 제시 및 동의 구하기</h2><h3 id=api-설계>API 설계</h3><p>호텔 예약 시스템의 가장 중요한 API만 RESTful 관례에 따라 표현하면 아래와 같다.</p><ul><li>검색 기능 등의 직관적인 기능도 필요하나, 기술적으로 도전적이지는 않다.</li></ul><p><strong>호텔 관련 API</strong></p><div class=table-wrapper><table><thead><tr><th>API</th><th>설명</th></tr></thead><tbody><tr><td>GET /v1/hotels/id</td><td>호텔의 상세 정보 반환</td></tr><tr><td>POST /v1/hotels</td><td>신규 호텔 추가(관리자)</td></tr><tr><td>PUT /v1/hotels/id</td><td>호텔 정보 갱신(관리자)</td></tr><tr><td>DELETE /v1/hotels/id</td><td>호텔 정보 삭제(관리자)</td></tr></tbody></table></div><p><strong>객실 관련 API</strong></p><div class=table-wrapper><table><thead><tr><th>API</th><th>설명</th></tr></thead><tbody><tr><td>GET /v1/hotels/:id/rooms/id</td><td>객실 상세 정보 반환</td></tr><tr><td>POST /v1/hotels/:id/rooms</td><td>신규 객실 추가(관리자)</td></tr><tr><td>PUT /v1/hotels/:id/rooms/id</td><td>객실 정보 갱신(관리자)</td></tr><tr><td>DELETE /v1/hotels/:id/rooms/id</td><td>객실 정보 삭제(관리자)</td></tr></tbody></table></div><p><strong>예약 관련 API</strong></p><div class=table-wrapper><table><thead><tr><th>API</th><th>설명</th></tr></thead><tbody><tr><td>GET /v1/reservations</td><td>로그인 사용자의 예약 이력 반환</td></tr><tr><td>GET /v1/reservations/id</td><td>특정 예약의 상세 정보 반환</td></tr><tr><td>POST /v1/reservations</td><td>신규 예약</td></tr><tr><td>DELETE /v1/reservations/id</td><td>예약 취소</td></tr></tbody></table></div><p>신규 예약 접수는 아주 중요한 기능으로, 새 예약을 만들 때 전달하는 인자의 형태는 아래와 같은데</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;startDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-04-28&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;endDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-04-30&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;hotelID&#34;</span><span class=p>:</span> <span class=s2>&#34;245&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roomID&#34;</span><span class=p>:</span> <span class=s2>&#34;U12354673389&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;reservationID&#34;</span><span class=p>:</span> <span class=s2>&#34;13422445&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>researvationID</code>는 <strong>이중 예약을 방지하고 동일한 예약은 단 한 번만 이루어지도록 보증하는 멱등 키(idempotent key)다.</strong></p><blockquote><p><strong>멱등성?</strong>
연산을 여러 번 적용하더라도 결과가 달라지지 않는 성질</p></blockquote><h3 id=데이터-모델>데이터 모델</h3><p>어떤 데이터베이스를 사용할지 결정하기위해 데이터 접근 패턴을 확인해야한다.</p><ol><li>호텔 상세 정보 확인</li><li>지정된 날짜 범위에 사용 가능한 객실 유형 확인</li><li>예약 정보 기록</li><li>예약 내역 또는 과거 예약 이력 정보 조회</li></ol><p>시스템 규모가 크지 않지만 대규모 이벤트 등으로 인해 트래픽이 급증할 수도 있으니 대비가 필요하다.</p><p>이런 요구사항을 종합적으로 고려하였을 때 <strong>관계형 데이터베이스</strong>가 적절해보인다.</p><ul><li>읽기 빈도가 쓰기 연산에 비해 높은 작업 흐름을 잘 지원한다.<ul><li>읽기 반도가 압도적인 작업 흐름은 충분히 잘 지원한다.</li><li>NoSQL 데이터베이스는 대체로 쓰기 연산에 최적화되어 있다.</li></ul></li><li>ACID 속성(원자성, 일관성, 격리성, 영속성)을 보장한다.<ul><li>예약이라는 도메인 특성으로 인해 ACID 속성은 매우 중요하다.</li><li>ACID를 보장하지 않으면 잔액 마이너스 문제, 이중 청구 문제, 이중 예약 문제 등을 방지하기 어렵다.</li><li>ACID 속성이 충족되는 데이터베이스를 사용하면 코드는 단순해지고 이해하기 쉬워진다.</li></ul></li><li>데이터를 쉽게 모델링 할 수 있다.<ul><li>비즈니스 데이터의 구조를 명확하게 표현할 수 있을 뿐 아니라 엔티티 간의 간계를 안정적으로 지원할 수 있다.</li></ul></li></ul><p><img src=/post/system-design-interview-2/7/img_1.png width=1622 height=1138 srcset="/post/system-design-interview-2/7/img_1_hude4e50a98d4fd9adb0d8d3f89cda06c5_259967_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_1_hude4e50a98d4fd9adb0d8d3f89cda06c5_259967_1024x0_resize_box_3.png 1024w" loading=lazy alt="데이터베이스 스키마" class=gallery-image data-flex-grow=142 data-flex-basis=342px></p><p><code>reservation</code> 테이블의 <code>status</code> 필드는 <code>Pending</code>, <code>Paid</code>, <code>Refunded</code>, <code>Canceled</code>, <code>Rejected</code> 다섯 상태 가운데 하나를 값으로 가질 수 있다.</p><p><img src=/post/system-design-interview-2/7/img_2.png width=1320 height=630 srcset="/post/system-design-interview-2/7/img_2_hu654fdd7d1e7937dbeca03f4655f81aa1_21966_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_2_hu654fdd7d1e7937dbeca03f4655f81aa1_21966_1024x0_resize_box_3.png 1024w" loading=lazy alt="예약 상태" class=gallery-image data-flex-grow=209 data-flex-basis=502px></p><p>이 스키마에서 <code>room_id</code>는 에어비엔비 같은 회사에는 적합하나, 특정 호텔의 특정 객실 유형을 예약하는 호텔에는 적절하지 않을 수 있다.</p><ul><li>객실 번호는 예약할 때가 아닌, 투숙객이 체크인 하는 시점에 부여된다.</li></ul><h3 id=개략적-설계안>개략적 설계안</h3><p>이번 호텔 예약 시스템에는 마이크로서비스 아키텍처를 사용한다.</p><p><img src=/post/system-design-interview-2/7/img_3.png width=1946 height=1100 srcset="/post/system-design-interview-2/7/img_3_hu282c3b24ada39ab6809ed01eac989c4e_87808_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_3_hu282c3b24ada39ab6809ed01eac989c4e_87808_1024x0_resize_box_3.png 1024w" loading=lazy alt="개략적 설계안" class=gallery-image data-flex-grow=176 data-flex-basis=424px></p><p>마이크로 서비스 간 상호작용을 나타내는 화살표 상당수를 생략하였다.</p><p>실제 상업적으로 이용되는 시스템의 서비스 간 통신에는 gRPC와 같은 고성능 원격 프로세서 호출 프레임워크를 사용하곤 한다.</p><blockquote><p><strong>gRPC?</strong><br>gRPC는 Google에서 개발한 고성능, 오픈 소스 원격 프로시저 호출(Remote Procedure Call, RPC) 프레임워크이다.
클라이언트와 서버 간에 원격 프로시저를 호출할 수 있게 해 주며, 마치 로컬에서 함수를 호출하는 것처럼 네트워크를 통해 다른 시스템의 메서드를 실행할 수 있다.
주로 프로토콜 버퍼(Protocol Buffers, protobuf)라는 직렬화 방식을 사용해 데이터를 효율적으로 전송하며, HTTP/2를 기반으로 동작해 성능과 확장성을 높인다.</p></blockquote><h2 id=3단계-상세-설계>3단계: 상세 설계</h2><h3 id=개선된-데이터-모델>개선된 데이터 모델</h3><p>호텔 객실을 예약할 때는 특정 객실이 아니라 특정한 객실 유형을 예약하게 된다.</p><p>이러한 특성을 반영하기 위해 예약 API의 경우 호출 인자 가운데 <code>roomID</code>는 <code>roomTypeID</code>로 변경한다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;startDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-04-28&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;endDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-04-30&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;hotelID&#34;</span><span class=p>:</span> <span class=s2>&#34;245&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roomTypeID&#34;</span><span class=p>:</span> <span class=s2>&#34;U12354673389&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;reservationID&#34;</span><span class=p>:</span> <span class=s2>&#34;13422445&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>스키마는 아래와 같이 변경된다.</p><p><img src=/post/system-design-interview-2/7/img_4.png width=1366 height=1028 srcset="/post/system-design-interview-2/7/img_4_hu481f8e14d20d4e775dd6afb82166b25a_281965_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_4_hu481f8e14d20d4e775dd6afb82166b25a_281965_1024x0_resize_box_3.png 1024w" loading=lazy alt="갱신된 스키마" class=gallery-image data-flex-grow=132 data-flex-basis=318px></p><p>주요 변경 사항은 아래와 같다.</p><ul><li><code>room</code>: 객실에 관계된 정보</li><li><code>room_type_rate</code>: 특정 객실 유형의 특정 일자 요금 정보</li><li><code>reservation</code>: 투숙객 예약 정보</li><li><code>room_type_inventory</code>: 호텔의 모든 객실 유형<ul><li><code>hotel_id</code>: 호텔 식별자</li><li><code>room_type_id</code>: 객실 유형 식별자</li><li><code>date</code>: 일자</li><li><code>total_inventory</code>: 총 객실 수에서 일시적으로 제외한 객실 수를 뺀 값<ul><li>유지 보수를 위해 예약 가능 목록에서 제외할 수도 있다.</li></ul></li><li><code>total_reserved</code>: 저정된 hotel_id, room_type_id, date에 예약된 모든 객실의 수</li></ul></li></ul><p>날짜당 하나의 레코드를 사용하면 날짜 범위 내에서 예약을 쉽게 관리하고 질의할 수 있다.</p><p>이 테이블의 기본키는 <code>(hotel_id, room_type_id, date)</code>의 복합키로, 2년 이내 모든 미래 날짜에 대한 가용 객실 데이터 질의 결과를 토대로 미리 채워 놓고, 시간이 흐름에 따라 새로 추가해야 하는 객실 정보는 매일 한 번씩 일괄 작업을 돌려 반영한다.</p><hr><p>5,000개의 호텔이 있고 각 호텔에는 20개의 객실 유형이 있으므로 테이블에 저장해야 하는 레코드의 수는 <code>5,000 * 20 * 2년 * 365일 = 7,300만 개</code> 정도이다.</p><p>많은 데이터가 아니므로 데이터베이스 하나면 저장하기 충분하지만, 하나만 둔다면 SPOF 문제를 피할 수 없게된다.</p><p>고가용성을 달성하려면 여러 지역, 또는 가용성 구역에 데이터베이스를 복제해 두어야 한다.</p><hr><p><code>room_type_inventory</code> 테이블은 고객이 특정 유형의 객실을 예약할 수 있는지 여부를 확인할 때 사용한다.</p><ul><li>입력<ul><li><code>startDate</code></li><li><code>endDate</code></li><li><code>roomTypeId</code></li><li><code>hotelId</code></li><li><code>numberOfRoomsToReserve</code></li></ul></li><li>출력<ul><li>해당 유형의 객실에 여유가 있고 예약 가능한 상태라면 <code>True</code>, 아니면 <code>False</code>를 반환한다.</li></ul></li></ul><p>SQL 관점에서 두 절차를 거친다.</p><ol><li><p>주어진 기간에 해당하는 레코드를 구한다.</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=nb>date</span><span class=p>,</span><span class=w> </span><span class=n>total_inventory</span><span class=p>,</span><span class=w> </span><span class=n>total_reserved</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>room_type_inventory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>room_type_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>${</span><span class=n>roomTypeId</span><span class=err>}</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>hotel_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>${</span><span class=n>hotelId</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=err>${</span><span class=n>startDate</span><span class=err>}</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=err>${</span><span class=n>endDate</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>반환한 각 레코드마다 다음 조건을 확인한다.</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>if ((total_reserved + ${numberOfRoomsToReserve}) &lt;= total_inventory)
</span></span></code></pre></td></tr></table></div></div></li><li>레코드의 모든 행을 검사한 결과 <code>True</code>가 반환되면 주어진 기간 내 모든 날짜에 충분한 객실이 있다는 뜻 이다.</li></ul></li></ol><hr><p>예약 데이터가 단을 데이터베이스에 담기에 너무 크다면 다음과 같은 방안을 생각해 볼 수 있다.</p><ul><li>현재 및 향후 예약 데이터만 저장한다.<ul><li>예약 이력은 자주 접근하지 않으므로 아카이빙 하거나 냉동 저장소로 옮길 수 있다.</li></ul></li><li>데이터베이스를 샤딩한다.<ul><li>자주 사용되는 질의는 <strong>예약</strong> 및 <strong>예약 확인</strong>이므로, 두 질의에서 모두 먼저 알아야하는 <code>hotel_id</code>를 샤딩키로 사용한다.</li><li>데이터는 <code>hash(hotel_id) % number_of_service</code></li></ul></li></ul><h3 id=동시성-문제>동시성 문제</h3><p>또 하나의 중요한 문제는 <strong>이중 예약 방지</strong>이며, 이를 위해 두가지 문제를 해결해야한다.</p><ul><li>같은 사용자가 예약 요청을 여러번 시도할 수 있다.</li><li>여러 사용자가 같은 객실을 동시에 예약하려 할 수 있다.</li></ul><h4 id=같은-사용자가-같은-예약-요청을-시도하는-경우><strong>같은 사용자가 같은 예약 요청을 시도하는 경우</strong></h4><p><img src=/post/system-design-interview-2/7/img_5.png width=1508 height=986 srcset="/post/system-design-interview-2/7/img_5_hueb9926d5bdf21d1ae178c13f6ba855ec_83059_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_5_hueb9926d5bdf21d1ae178c13f6ba855ec_83059_1024x0_resize_box_3.png 1024w" loading=lazy alt="같은 고객의 이중 예약" class=gallery-image data-flex-grow=152 data-flex-basis=367px></p><p>이 문제를 푸는 일반적인 접근법으로는 다음 두가지가 있다.</p><ul><li>클라이언트 측 구현<ul><li>요청 전송 후 예약 버튼을 비활성화 한다.<ul><li>클라이언트에서 우회 가능하다.</li></ul></li></ul></li><li>멱등 API<ul><li>예약 API 요청에 멱등 키를 추가하는 방안</li><li><code>reservation_id</code>를 멱등 키로 사용하여 이중 예약 문제를 해결하는 방안이다.</li></ul></li></ul><p><img src=/post/system-design-interview-2/7/img_6.png width=1130 height=1066 srcset="/post/system-design-interview-2/7/img_6_hu48c6b4b2100602be71a6178ae06987e2_69862_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_6_hu48c6b4b2100602be71a6178ae06987e2_69862_1024x0_resize_box_3.png 1024w" loading=lazy alt="유일성 조건" class=gallery-image data-flex-grow=106 data-flex-basis=254px></p><ol><li>예약 주문서를 만든다.</li><li>고객이 검토할 수 있도록 예약 주문서를 반환한다.</li></ol><ul><li>반환 결과에 <code>reservation_id</code>를 넣는다.(전역적 유일성을 보증하는 ID, 예제에서는의 예약 테이블의 기본키)</li></ul><ol start=3><li>검토가 끝난 예약을 전송한다.<ul><li>요청에 <code>reservation_id</code>를 포함한다.</li></ul></li><li>예약 완료 버튼을 한 번 더 눌러 보내도 <code>reservation_id</code>가 예약 테이블의 기본 키 이므로 유일성 조건에 위반되어 처리되지 않는다.</li></ol><h4 id=여러-사용자가-하나뿐인-객실을-동시에-예약하는-경우><strong>여러 사용자가 하나뿐인 객실을 동시에 예약하는 경우</strong></h4><p><img src=/post/system-design-interview-2/7/img_7.png width=1438 height=1262 srcset="/post/system-design-interview-2/7/img_7_hu8a18da16175039b3cfa48b49d042fdf5_80735_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_7_hu8a18da16175039b3cfa48b49d042fdf5_80735_1024x0_resize_box_3.png 1024w" loading=lazy alt="경쟁 조건" class=gallery-image data-flex-grow=113 data-flex-basis=273px></p><p>이 문제를 해결하려면 어떤 형태로든 락을 활용해야 한다.</p><p><strong>비관적 락</strong></p><p>비관적 락은 비관적 동시성 제어 방안이라고도 불리며, 사용자가 <strong>레코드를 갱신하려고 하는 순간 즉시 락을 걸어 동시 업데이트를 방지하는 기술</strong>이다.</p><p>따라서 해당 레코드를 갱신하려는 다른 사용자는 락 해제를 기다려야 한다.</p><ul><li>MySQL 같은 경우는 <code>SELECT ... FOR UPDATE</code> 문을 실행하면 <code>SELECT</code>가 반환한 레코드에 락이 걸린다.</li></ul><p><img src=/post/system-design-interview-2/7/img_8.png width=1994 height=1320 srcset="/post/system-design-interview-2/7/img_8_hu40fa4d62dd848fb68c0b889e46e94f87_126013_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_8_hu40fa4d62dd848fb68c0b889e46e94f87_126013_1024x0_resize_box_3.png 1024w" loading=lazy alt="비관적 락" class=gallery-image data-flex-grow=151 data-flex-basis=362px></p><ul><li>장점<ul><li>변경 중이거나 변경이 끝난 데이터를 갱신하는 일을 막을 수 있다.</li><li>구현이 쉽고 모든 갱신 연산을 직렬화하여 충돌을 막는다.</li><li>데이터에 대한 경합이 심할 때 유용하다.</li></ul></li><li>단점<ul><li>여러 레코드에 락을 걸면 교착 상태가 발생할 수 있다.<ul><li>교착 상태가 발생하지 않는 코드 작성은 어렵다</li></ul></li><li>확장성이 낮다.</li><li>트랜잭션이 너무 오랫동안 락을 해제하지 않고 있으면 다른 트랜잭션은 락이 걸린 자원에 접근할 수 없어 트랜잭션 수명이 길거나 많은 엔티티에 관련된 경우 성능에 심각한 영향을 끼친다.</li></ul></li></ul><p>이러한 이유로 비관적 락 메커니즘은 군장하지 않는다.</p><p><strong>낙관적 락</strong></p><p>낙관적 락은 <strong>낙관적 동시성 제어</strong>라고도 불리는 방안으로 <strong>여러 사용자가 동시에 같은 자원을 갱신하려 시도하는 것을 허용</strong>한다.</p><p>일반적으로 버전 번호(version_number)와 타임스탬프(timestamp) 두 가지 방법으로 구현한다.</p><ul><li>서버 시계는 시간이 지남에 따라 부정확해질 수 있으므로 일반적으로는 버전 번호를 더 나은 선택지로 본다.</li></ul><p><img src=/post/system-design-interview-2/7/img_9.png width=1938 height=1142 srcset="/post/system-design-interview-2/7/img_9_hu9411dd474af31fd86c2a43d5119b3270_97882_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_9_hu9411dd474af31fd86c2a43d5119b3270_97882_1024x0_resize_box_3.png 1024w" loading=lazy alt="낙관적 락" class=gallery-image data-flex-grow=169 data-flex-basis=407px></p><p>낙관적 락은 데이터베이스에 직접 락을 걸지 않으므로 일반적으로 비관적 락 보다 빠르지만 동시성 수준이 아주 높으면 성능이 급격히 나빠진다.</p><p>예를 들어 설명하면 잔여 객실 수를 읽을 수 있는 클라이언트 수에는 제한이 없으므로, 모든 클라이언트는 같은 잔여 객실 수와 같은 버전 정보를 취득하게 될 수 있기 때문에 모든 클라이언트는 같은 잔여 객실 수와 같은 버전 번호 정보를 취득한다.</p><p>하지만 실제로 버전 번호 갱신에 성공하는 클라이언트는 하나이므로, 다른 모든 클라이언트는 버전 번호 검사에 실패하게된다.</p><ul><li>장점<ul><li>애플리케이션이 유효하지 않은 데이터를 편집하는 일을 막는다.</li><li>데이터베이스 자원에 락을 걸 필요가 없다.(데이터베이스 관점에서 락은 없다.) 책임은 애플리케이션에 있다.</li><li>데이터에 대한 경쟁이 치열하지 않은 상황에 적합하다.<ul><li>락을 관리하는 비용 없이 트랜잭션을 실행할 수 있다.</li></ul></li></ul></li><li>단점<ul><li>데이터에 대한 경쟁이 치열한 상황에서는 성능이 좋지 못하다.</li></ul></li></ul><p>낙관적 락은 예약 QPS가 일반적으로 높지 않은 호텔 예약 시스템에서는 적합한 선택지이다.</p><p><strong>데이터베이스 제약 조건</strong></p><p>낙관적 락과 아주 유사하게 동작한다.</p><p><code>room_type_inventory</code> 테이블에 다음 제약 조건을 추가한다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CONSTRAINT</span><span class=w> </span><span class=o>`</span><span class=n>check_room_count</span><span class=o>`</span><span class=w> </span><span class=k>CHECK</span><span class=p>((</span><span class=o>`</span><span class=n>total_inventory</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>total_reserved</span><span class=o>`</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/post/system-design-interview-2/7/img_10.png width=1478 height=1368 srcset="/post/system-design-interview-2/7/img_10_hu8a54ba9888669d6b439cae205e8f7b91_81051_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_10_hu8a54ba9888669d6b439cae205e8f7b91_81051_1024x0_resize_box_3.png 1024w" loading=lazy alt="데이터 베이스 제약 조건" class=gallery-image data-flex-grow=108 data-flex-basis=259px></p><p>사용자가 객실을 예약하려면 <code>total_reserved</code>의 값이 101으로 제약 조건을 위반하게되어 롤백된다.</p><ul><li>장점<ul><li>구현이 쉽다.</li><li>데이터에 대한 경쟁이 심하지 않을 때 잘 동작한다.</li></ul></li><li>단점<ul><li>데이터에 대한 경쟁이 심하면 실패하는 연산 수가 매우 늘어날 수 있다.</li><li>데이터베이스 제약 조건은 애플리케이션 코드와 달라서 버전을 통제하기 어렵다.</li><li>제약 조건을 허용하지 않는 데이터베이스도 있으므로 마이그레이션 등에 문제가 될 수 있다.</li></ul></li></ul><h3 id=시스템-규모-확장>시스템 규모 확장</h3><p>일반적으로 호텔 예약 시스템에 대한 부하는 높지 않지만, 유명한 여행 예약 웹 사이트와 연동이 되어야한다면 QPS는 매우 늘어날 수 있다.</p><p>시스템 부하가 높을 때는 무엇이 병목이 될 수 있는지 이해해야한다.</p><ul><li>해당 시스템의 모든 서비스는 무상태 서비스이므로 서버를 추가하는 것으로 성능 문제는 해결할 수 있다.</li><li>데이터베이스는 단순히 데이터베이스 서버를 늘리는 것만으로는 성능 문제를 해결할 수 없다.</li></ul><h4 id=데이터베이스-샤딩>데이터베이스 샤딩</h4><p>데이터베이스를 여러 대 두고, 각각에 데이터의 일부만 보관하도록 하는 방식이다.</p><p>데이터베이스를 샤딩할 때는 데이터를 어떻게 분배할 지 먼저 정한다.</p><ul><li><code>hotel_id</code>를 필터링 조건으로 사용하므로 샤딩 조건으로 쓰면 좋다.</li></ul><p><img src=/post/system-design-interview-2/7/img_11.png width=1964 height=1122 srcset="/post/system-design-interview-2/7/img_11_hu98af43fce089f7bbf6f6bf1fb85b60d6_147947_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_11_hu98af43fce089f7bbf6f6bf1fb85b60d6_147947_1024x0_resize_box_3.png 1024w" loading=lazy alt="데이터베이스 샤딩" class=gallery-image data-flex-grow=175 data-flex-basis=420px></p><p>위는 16개 샤드로 분산하는 사례로, QPS가 30,000이라면 샤딩 후에는 1875QPS 정도로 한 대의 MySQL 서버로도 감당할 수 있는 부하가 된다.</p><h4 id=캐시>캐시</h4><p>호텔 잔여 객실 데이터는 현재와 미래의 데이터만 중요하다는 특성이 있다.</p><p>따라서 데이터를 보관할 때 낡은 데이터는 자동적으로 소멸되도록 TTL을 설정할 수 있다면 바람직하다.</p><ul><li>이력 데이터는 다른 데이터베이스를 통해 질의하도록 하면 된다.</li></ul><p>이런 상황에 레디스는 매우 적합하다.</p><hr><p>데이터 로딩 속도와 데이터베이스 확장성이 문제가 되기 시작하면 데이터베이스 앞에 캐시 계층을 두고 잔여 객실 확인 및 객실 예약 로직이 해당 계층에서 실행되도록 할 수 있다.</p><p>요청의 일부만 잔여 객실 데이터베이스가 처리하고 나머지는 캐시가 담당하도록 한다.</p><ul><li>레디스 캐시 데이터에는 잔여 객실이 충분해 보여도 실제 데이터베이스를 다시 한번 확인해야한다.</li></ul><p><img src=/post/system-design-interview-2/7/img_12.png width=1094 height=682 srcset="/post/system-design-interview-2/7/img_12_hu5d3b54b38dcf02612143f1622e8a715a_133204_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_12_hu5d3b54b38dcf02612143f1622e8a715a_133204_1024x0_resize_box_3.png 1024w" loading=lazy alt=캐시 class=gallery-image data-flex-grow=160 data-flex-basis=384px></p><ul><li><p><strong>예약 서비스</strong>: 다음과 같은 잔여 객실 관리 API를 제공한다.</p><ul><li>지정된 호텔과 객실 유형, 주어진 날짜 범위에 이용 가능한 객실의 수를 질의</li><li>객실을 예약하고 <code>total_reserved</code>의 값을 1 증가</li><li>고객이 예약을 취소하면 잔여 객실 수를 갱신</li></ul></li><li><p><strong>잔여 객실 캐시</strong></p><ul><li>모든 잔여 객실 관리에 필요한 질의는 레디스로 구현되는 잔여 객실 캐시로 옮긴다.</li><li>따라서 사전에 잔여 객실 정보를 캐시에 미리 저장해두어야 한다.</li><li>캐시에 저장되는 데이터 형식<ul><li>키: <code>hotelID_roomTypeId_{날짜}</code></li><li>값<ul><li>주어진 호텔 ID</li><li>객실 유형 ID</li><li>날짜에 맞는 잔여 객실 수</li></ul></li></ul></li><li>호텔 예약 시스템은 잔여 객실 확인 작업 때문에 읽기 연산 빈도가 쓰기 연산보다 훨씬 많으므로 대부분의 읽기 연산을 캐시로 처리하면 좋다.</li></ul></li><li><p><strong>잔여 객실 데이터베이스</strong></p><ul><li>잔여 객실 수에 대한 가장 믿을 만한 정보가 보관되는 장소</li></ul></li></ul><hr><p><strong>캐시가 주는 새로운 과제</strong></p><p>캐시 계층을 추가하면 시스템의 확장성과 처리량은 대폭 증가하지만 데이터베이스와 캐시 사이의 데이터 일관성 유지에 관한 새로운 문제가 생긴다.</p><p>사용자가 객실을 예약할 때 아무 문제가 없는 경우에는 다음 두 가지 작업이 이루어진다.</p><ol><li>잔여 객실 수를 질의하여 충분한지 확인(캐시)</li><li>잔여 객실 데이터를 갱신<ul><li>데이터베이스 갱신 이후 캐시 갱신</li><li>비동기적으로 실행</li><li>변경 데이터 감지(CDC) 매커니즘을 활용할 수 있다.<ul><li>데이터베이스에서 발생한 변화를 감지하여 해당 변경 내역을 다른 시스템에 적용할 수 있도록 하는 매커니즘</li></ul></li></ul></li></ol><p>잔여 객실 데이터에 대한 변화를 데이터베이스에 먼저 반영하므로 캐시에는 최신 데이터가 없을 가능성이 있다.</p><ul><li><p>이러한 불일치 문제는 데이터베이스가 최종적으로 잔여 객실 확인을 하도록 한다면 문제가 되지는 않는다.</p></li><li><p>장점</p><ul><li>읽기 질의를 캐시가 처리하므로 데이터베이스의 부하가 크게 줄어든다.</li><li>읽기 질의를 메모리에서 실행하므로 높은 성능을 보장할 수 있다.</li></ul></li><li><p>단점</p><ul><li>데이터베이스와 캐시 사이의 데이터 일관성을 유지하는 것은 어렵다.<ul><li>데이터 불일치가 사용자 경험에 끼치는 영향을 신중하게 살펴야한다.</li></ul></li></ul></li></ul><h3 id=서비스-간-데이터-일관성>서비스 간 데이터 일관성</h3><p>모노리스 아키텍처의 경우 데이터의 일광성을 보장하기 위해 관계형 데이터베이스를 공유하는 것이 보통이지만, 해당 시스템은 예약 테이블과 잔여 객실 테이블만 동일한 관계형 데이터베이스에 저장하는 MSA 하이브리드 접근법을 사용한다.</p><p><img src=/post/system-design-interview-2/7/img_13.png width=1920 height=514 srcset="/post/system-design-interview-2/7/img_13_huc5f5e8f7744db63fc867cea3c0d26387_55893_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_13_huc5f5e8f7744db63fc867cea3c0d26387_55893_1024x0_resize_box_3.png 1024w" loading=lazy alt="모노리스 vs 마이크로서비스" class=gallery-image data-flex-grow=373 data-flex-basis=896px></p><p>이를 통해 관계형 데이터베이스의 ACID 속성을 활용하여 동시성 문제를 효과적으로 대응할 수 있지만, MSA 순수 주의자라면 마이크로 서비스가 독자적인 데이터베이스를 갖추고 있어야 한다고 주장할 수 있다.</p><p><img src=/post/system-design-interview-2/7/img_15.png width=1362 height=1150 srcset="/post/system-design-interview-2/7/img_15_hu1651b063c3947755463e1494fe52dabe_39875_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_15_hu1651b063c3947755463e1494fe52dabe_39875_1024x0_resize_box_3.png 1024w" loading=lazy alt="모노리스 아키텍처" class=gallery-image data-flex-grow=118 data-flex-basis=284px></p><p>모노리스 아키텍처는 하나의 데이터베이스만 사용하므로 여러 연산을 하나의 트랜잭션으로 묶어 ACID 속성이 만족되도록 보장할 수 있다.</p><p><img src=/post/system-design-interview-2/7/img_14.png width=1748 height=1062 srcset="/post/system-design-interview-2/7/img_14_hu657f4a94828478d72376098f027fabfa_59765_480x0_resize_box_3.png 480w, /post/system-design-interview-2/7/img_14_hu657f4a94828478d72376098f027fabfa_59765_1024x0_resize_box_3.png 1024w" loading=lazy alt="마이크로서비스 아키텍처" class=gallery-image data-flex-grow=164 data-flex-basis=395px></p><p>하지만 서비스가 독자적인 데이터베이스를 갖도록 하면, 논리적으로는 하나의 원자적 연산이 여러 데이터베이스에 걸쳐 실행되는 일을 피할 수 없다.</p><ul><li>하나의 트랜잭션으로 데이터 일관성을 보증하는 기법을 사용할 수 없다.</li></ul><p>이러한 데이터 일관성 문제를 해결하기 위해 널리 사용되는 방법은 2가지 정도가 있다.</p><ul><li>2단계 커밋(2-phase commit, 2PC)<ul><li>여러 노드에 걸친 원자적 트랜잭션 실행을 보증하는 데이터베이스 프로토콜</li><li>모든 노드가 성공하든 아니면 실패하든 둘 중 하나로 트랜잭션이 마무리되도록 보증</li><li>비중단 실행이 가능한 프로토콜이 아니므로 어느 한 노드에 장애가 발생하면 해당 장애가 복구될 때까지 진행이 중단된다.(성능이 뛰어난 프로토콜은 아니다.)</li></ul></li><li>사가(Saga)<ul><li>각 노드에 국지적으로 발생하는 트랜잭션을 하나로 엮는다.</li><li>각각의 트랜잭션은 완료되면 다음 트랜잭션을 시작하는 트리거로 쓰일 메시지를 만드러 보낸다.</li><li>한 트랜잭션이라도 실패하면 그 이전 트랜잭션의 결과를 전부 되될리는 트랜잭션들을 순차적으로 실행한다.</li><li>2pc는 여러 노드에 걸친 하나의 트랜잭션을 통해 ACID 속성을 만족시키는 개념이지만 사가는 각 단계가 하나의 트랜잭션이라서 결과적 일관성에 의존하는 것으로 본다.</li></ul></li></ul><p>마이크로서비스 간의 데이터 불일치를 해결하기 위해 사용되는 복잡한 매커니즘은 시스템 전체 설계의 복잡성을 크게 증가시킨다.<br>증가한 복잡성이 그만한 가치가 있는 지 결정하는 것은 설계자의 몫이다.</p><ul><li>이번 설계안은 그만한 가치는 없다고 판단하여 예약 및 잔여 객실 정보를 동일한 관계형 데이터베이스에 저장하는 좀 더 실용적인 접근 방법을 선택했다.</li></ul><h2 id=4단계-마무리>4단계: 마무리</h2><ul><li>경쟁 조건이 발생할 수 있는 시나리오<ul><li>비관적 락</li><li>낙관적 락</li><li>데이터베이스 제약 조건</li></ul></li><li>규모 확장<ul><li>데이터베이스 샤딩</li><li>레디스 캐시</li></ul></li><li>마이크로아키텍처의 데이터 일관성 문제</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/%EA%B0%80%EC%83%81-%EB%A9%B4%EC%A0%91-%EC%82%AC%EB%A1%80%EB%A1%9C-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8C%80%EA%B7%9C%EB%AA%A8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%84%A4%EA%B3%84-%EA%B8%B0%EC%B4%88/>가상 면접 사례로 배우는 대규모 시스템 설계 기초</a>
<a href=/tags/system-design-interview/>System Design Interview</a>
<a href=/tags/msa/>MSA</a>
<a href=/tags/micro-service-architecture/>Micro Service Architecture</a>
<a href=/tags/rdbms/>RDBMS</a>
<a href=/tags/relational-database-system/>Relational Database System</a>
<a href=/tags/%EB%8F%99%EC%8B%9C%EC%84%B1/>동시성</a>
<a href=/tags/concurrency/>Concurrency</a>
<a href=/tags/%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD/>비관적 락</a>
<a href=/tags/pessimistic-lock/>Pessimistic Lock</a>
<a href=/tags/%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD/>낙관적 락</a>
<a href=/tags/optimistic-lock/>Optimistic Lock</a>
<a href=/tags/%EC%BA%90%EC%8B%9C/>캐시</a>
<a href=/tags/cache/>Cache</a>
<a href=/tags/%EB%A0%88%EB%94%94%EC%8A%A4/>레디스</a>
<a href=/tags/redis/>Redis</a>
<a href=/tags/%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%9D%BC%EA%B4%80%EC%84%B1/>데이터 일관성</a>
<a href=/tags/consistency/>Consistency</a>
<a href=/tags/%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98/>트랜잭션</a>
<a href=/tags/transaction/>Transaction</a>
<a href=/tags/2%EB%8B%A8%EA%B3%84-%EC%BB%A4%EB%B0%8B/>2단계 커밋</a>
<a href=/tags/2-phase-commit/>2 Phase Commit</a>
<a href=/tags/%EC%82%AC%EA%B0%80/>사가</a>
<a href=/tags/saga/>Saga</a>
<a href=/tags/%EA%B2%B0%EA%B3%BC%EC%A0%81-%EC%9D%BC%EA%B4%80%EC%84%B1/>결과적 일관성</a>
<a href=/tags/eventual-consistency/>Eventual Consistency</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><div class="article-list--compact links"><article><a href=https://product.kyobobook.co.kr/detail/S000211656186 target=_blank rel=noopener><div class=article-details><h2 class=article-title>가상 면접 사례로 배우는 대규모 시스템 설계 기초 2</h2><footer class=article-time>교보문고</footer></div></a></article></div><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/post/system-design-interview-2/12/><div class=article-image><img src=/post/system-design-interview-2/12/cover.eb0176bd1597a4b4423be0cc9ee612d7_huf565d8fe7a4f9f5a961306624616abfc_449360_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 12. 전자 지갑" data-key=system-design-interview-2/12 data-hash="md5-6wF2vRWXpLRCO+DMnuYS1w=="></div><div class=article-details><h2 class=article-title>12. 전자 지갑</h2></div></a></article><article class=has-image><a href=/post/system-design-interview-2/8/><div class=article-image><img src=/post/system-design-interview-2/8/cover.eb0176bd1597a4b4423be0cc9ee612d7_huf565d8fe7a4f9f5a961306624616abfc_449360_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 8. 분산 메일 서비스" data-key=system-design-interview-2/8 data-hash="md5-6wF2vRWXpLRCO+DMnuYS1w=="></div><div class=article-details><h2 class=article-title>8. 분산 메일 서비스</h2></div></a></article><article class=has-image><a href=/post/system-design-interview-2/10/><div class=article-image><img src=/post/system-design-interview-2/10/cover.eb0176bd1597a4b4423be0cc9ee612d7_huf565d8fe7a4f9f5a961306624616abfc_449360_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 10. 실시간 게임 순위표" data-key=system-design-interview-2/10 data-hash="md5-6wF2vRWXpLRCO+DMnuYS1w=="></div><div class=article-details><h2 class=article-title>10. 실시간 게임 순위표</h2></div></a></article><article class=has-image><a href=/post/system-design-interview-2/3/><div class=article-image><img src=/post/system-design-interview-2/3/cover.eb0176bd1597a4b4423be0cc9ee612d7_huf565d8fe7a4f9f5a961306624616abfc_449360_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 3. 구글 맵" data-key=system-design-interview-2/3 data-hash="md5-6wF2vRWXpLRCO+DMnuYS1w=="></div><div class=article-details><h2 class=article-title>3. 구글 맵</h2></div></a></article><article class=has-image><a href=/post/system-design-interview-2/2/><div class=article-image><img src=/post/system-design-interview-2/2/cover.eb0176bd1597a4b4423be0cc9ee612d7_huf565d8fe7a4f9f5a961306624616abfc_449360_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 2. 주변 친구" data-key=system-design-interview-2/2 data-hash="md5-6wF2vRWXpLRCO+DMnuYS1w=="></div><div class=article-details><h2 class=article-title>2. 주변 친구</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=codemario318/codemario318.github.io issue-term=pathname label=Comment crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2025 Mario Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>